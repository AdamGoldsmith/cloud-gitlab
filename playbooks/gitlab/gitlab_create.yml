---

- name: Cloud provider GitLab deployment
  hosts: localhost
  connection: local
  gather_facts: no
  tags:
    - create
    - gitlab
    - gitlab_create

  tasks:

    - name: Deploy GitLab cloud configuration resources
      vars:
        service_name: gitlab
        tf_vars:
          service_name: "{{ service_name }}"
          region_name: "{{ project_region }}"
          network_name: "{{ project_data['network']['name'] }}"
      terraform:
        project_path: "{{ inventory_dir |
          default(ansible_inventory_sources[0])
          }}/../terraform/{{ cloud_provider }}/{{ service_name }}"
        state: present
        force_init: yes
        lock: yes
        variables: "{{ tf_cred_data |
          combine(tf_vars) |
          combine(project_data['services'][service_name]) }}"
        backend_config: "{{ tf_backend_config }}"
      when:
        - cloud_provider is defined
        - cloud_provider == 'gcp'

  post_tasks:

    - name: Refresh inventory to ensure new instances exist in inventory
      meta: refresh_inventory

- name: Wait for connectivity to new hosts
  hosts: gitlab
  gather_facts: no
  tags:
    - create
    - gitlab
    - gitlab_create

  tasks:

    - name: Wait for host connectivity
      wait_for_connection:
