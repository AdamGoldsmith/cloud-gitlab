---

- name: Cloud provider base configuration creation
  hosts: localhost
  connection: local
  gather_facts: no
  tags:
    - create
    - base
    - base_create

  tasks:

    - name: GCP block
      block:

        # Use Ansible to create bucket for storing terraform remote state files
        # TODO: May move this to terraform as it's always showing "changed" - investigate why first
        - name: Create terraform backend storage bucket
          gcp_storage_bucket:
            name: "{{ gcp_data['project_name'] }}-tfstate"
            location: "{{ project_region }}"
            versioning:
              enabled: yes
            project: "{{ gcp_data['project_name'] }}"
            auth_kind: "{{ gcp_data['auth_kind'] }}"
            service_account_file: "{{ gcp_data['cred_file'] | expanduser }}"
            state: present

        - name: Deploy base cloud configuration resources
          vars:
            service_name: base
            tf_vars:
              region_name: "{{ project_region }}"
              network_name: "{{ project_data['network']['name'] }}"
          terraform:
            project_path: "{{ inventory_dir |
              default(ansible_inventory_sources[0])
              }}/../terraform/{{ cloud_provider }}/{{ service_name }}"
            state: present
            force_init: yes
            lock: yes
            variables: "{{ tf_cred_data |
              combine(tf_vars) }}"
            backend_config: "{{ tf_backend_config }}"

      when:
        - cloud_provider is defined
        - cloud_provider == 'gcp'

  # TODO: necessary here?
  post_tasks:

    - name: Refresh inventory to ensure new instances exist in inventory
      meta: refresh_inventory
